@page "/poa/editar/{InstanciaId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Infrastructure.Services
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Components.Pages.POA
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Data
@using Microsoft.EntityFrameworkCore
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.POA
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Components.Shared

@inject POAService POAService
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Editar POA</PageTitle>

<style>
    .mythra-header {
        background: linear-gradient(90deg, #4D3935 0%, #6D534F 100%);
        color: #FEFEFD;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .mythra-card {
        background: linear-gradient(135deg, #FEFEFD 0%, #F7F7F7 100%);
        border-left: 4px solid #4D3935;
    }

    .mythra-section {
        background: #F7F7F7;
        border-left: 3px solid #9FD996;
        padding: 1rem;
        margin: 1.5rem 0;
        border-radius: 4px;
    }

    .mythra-button-primary {
        background: linear-gradient(135deg, #9FD996 0%, #85C97C 100%) !important;
        color: #4D3935 !important;
        font-weight: 600 !important;
    }

    .mythra-button-secondary {
        background-color: transparent !important;
        border: 2px solid #4D3935 !important;
        color: #4D3935 !important;
        font-weight: 600 !important;
    }

    .metric-card {
        background: white;
        border-left: 3px solid #F7C484;
        padding: 0.8rem;
        border-radius: 4px;
    }
</style>

<AutorizacionWrapper RolesRequeridos="Administrador">
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="mythra-header">
        <MudText Typo="Typo.h4">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
            Editar POA
        </MudText>
        <MudText Typo="Typo.body1" Class="mt-2" Style="opacity: 0.9;">
            Programa: @(_poa?.ProgramaNombre ?? "Cargando...") - @(_poa?.PeriodoTexto ?? "")
        </MudText>
    </div>

    @if (_cargando)
    {
        <div style="text-align: center; padding: 2rem;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (_poa == null)
    {
        <MudAlert Severity="Severity.Error">POA no encontrado</MudAlert>
    }
    else
    {
        <MudPaper Class="mythra-card pa-6" Elevation="3">
            <MudGrid>
                <!-- Información General -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                            Información General
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12">
                                <MudText Typo="Typo.body1" Class="mb-2">
                                    <strong>Programa:</strong> @_poa.ProgramaNombre
                                </MudText>
                                <MudText Typo="Typo.body2" Style="color: #6D534F;">
                                    <strong>Periodo:</strong> @_poa.PeriodoTexto
                                </MudText>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudTextField @bind-Value="_modelo.Notas" 
                                             Label="Notas / Descripción" 
                                             Lines="3"
                                             Variant="Variant.Outlined" />
                            </MudItem>
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Planificación de Actividades -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.EventNote" Class="mr-2" />
                            Planificación de Actividades
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.ActividadesPlanificadas" 
                                                T="int"
                                                Label="Actividades Planificadas" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.CalendarMonth" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.ActividadesEjecutadas" 
                                                T="int"
                                                Label="Actividades Ejecutadas" 
                                                Min="0"
                                                Max="@_modelo.ActividadesPlanificadas"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.CheckCircle" />
                            </MudItem>

                            @if (_modelo.ActividadesPlanificadas > 0)
                            {
                                <MudItem xs="12">
                                    <div class="metric-card">
                                        <MudText Typo="Typo.body2" Style="color: #6D534F;">
                                            <strong>Cumplimiento de Actividades:</strong> 
                                            @CalcularPorcentaje(_modelo.ActividadesEjecutadas, _modelo.ActividadesPlanificadas)%
                                        </MudText>
                                        <MudProgressLinear Color="Color.Success" 
                                                          Value="@CalcularPorcentaje(_modelo.ActividadesEjecutadas, _modelo.ActividadesPlanificadas)" 
                                                          Class="mt-2" />
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Presupuesto -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Class="mr-2" />
                            Presupuesto
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.PresupuestoTotal" 
                                                T="decimal?"
                                                Label="Presupuesto Total" 
                                                Min="0"
                                                Format="N2"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentText="$" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.PresupuestoEjecutado" 
                                                T="decimal?"
                                                Label="Presupuesto Ejecutado" 
                                                Min="0"
                                                Max="@_modelo.PresupuestoTotal"
                                                Format="N2"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentText="$" />
                            </MudItem>

                            @if (_modelo.PresupuestoTotal.HasValue && _modelo.PresupuestoTotal.Value > 0)
                            {
                                <MudItem xs="12">
                                    <div class="metric-card">
                                        <MudText Typo="Typo.body2" Style="color: #6D534F;">
                                            <strong>Ejecución Presupuestaria:</strong> 
                                            @CalcularPorcentajeDecimal(_modelo.PresupuestoEjecutado ?? 0, _modelo.PresupuestoTotal.Value)%
                                        </MudText>
                                        <MudProgressLinear Color="Color.Info" 
                                                          Value="@CalcularPorcentajeDecimal(_modelo.PresupuestoEjecutado ?? 0, _modelo.PresupuestoTotal.Value)" 
                                                          Class="mt-2" />
                                        <MudText Typo="Typo.caption" Class="mt-1">
                                            Saldo: $@FormatearMoneda((_modelo.PresupuestoTotal ?? 0) - (_modelo.PresupuestoEjecutado ?? 0))
                                        </MudText>
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Participantes -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Groups" Class="mr-2" />
                            Participantes / Beneficiarios
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.TotalParticipantes" 
                                                T="int?"
                                                Label="Total Participantes" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Person" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.ParticipantesActivos" 
                                                T="int?"
                                                Label="Participantes Activos" 
                                                Min="0"
                                                Max="@_modelo.TotalParticipantes"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.PersonAdd" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.NuevosParticipantes" 
                                                T="int?"
                                                Label="Nuevos Participantes (este periodo)" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.GroupAdd" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.ParticipantesRetirados" 
                                                T="int?"
                                                Label="Participantes Retirados" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.PersonRemove" />
                            </MudItem>

                            @if (_modelo.TotalParticipantes.HasValue && _modelo.TotalParticipantes.Value > 0)
                            {
                                <MudItem xs="12">
                                    <div class="metric-card">
                                        <MudText Typo="Typo.body2" Style="color: #6D534F;">
                                            <strong>Retención de Participantes:</strong> 
                                            @CalcularPorcentaje(_modelo.ParticipantesActivos ?? 0, _modelo.TotalParticipantes.Value)%
                                        </MudText>
                                        @if (_modelo.PresupuestoTotal.HasValue && _modelo.PresupuestoTotal.Value > 0)
                                        {
                                            <MudText Typo="Typo.caption" Class="mt-1">
                                                Costo por participante: $@FormatearMoneda(_modelo.PresupuestoTotal.Value / _modelo.TotalParticipantes.Value)
                                            </MudText>
                                        }
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Recursos Humanos -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Engineering" Class="mr-2" />
                            Recursos Humanos
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.TotalFacilitadores" 
                                                T="int?"
                                                Label="Total Facilitadores" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.School" />
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.TotalVoluntarios" 
                                                T="int?"
                                                Label="Total Voluntarios" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.VolunteerActivism" />
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.HorasVoluntariado" 
                                                T="int?"
                                                Label="Horas de Voluntariado" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Schedule" />
                            </MudItem>

                            @if ((_modelo.TotalFacilitadores ?? 0) + (_modelo.TotalVoluntarios ?? 0) > 0)
                            {
                                <MudItem xs="12">
                                    <div class="metric-card">
                                        <MudText Typo="Typo.body2" Style="color: #6D534F;">
                                            <strong>Equipo Total:</strong> @((_modelo.TotalFacilitadores ?? 0) + (_modelo.TotalVoluntarios ?? 0)) personas
                                        </MudText>
                                        @if (_modelo.TotalParticipantes.HasValue && _modelo.TotalParticipantes.Value > 0)
                                        {
                                            var ratio = (decimal)_modelo.TotalParticipantes.Value / ((_modelo.TotalFacilitadores ?? 0) + (_modelo.TotalVoluntarios ?? 0) == 0 ? 1 : ((_modelo.TotalFacilitadores ?? 0) + (_modelo.TotalVoluntarios ?? 0)));
                                            <MudText Typo="Typo.caption" Class="mt-1">
                                                Ratio participantes/equipo: @ratio.ToString("N1"):1
                                            </MudText>
                                        }
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Impacto y Resultados -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="mr-2" />
                            Impacto y Resultados
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.ObjetivosTotales" 
                                                T="int?"
                                                Label="Objetivos Planteados" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Flag" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.ObjetivosCumplidos" 
                                                T="int?"
                                                Label="Objetivos Cumplidos" 
                                                Min="0"
                                                Max="@_modelo.ObjetivosTotales"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.CheckCircle" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.FamiliasImpactadas" 
                                                T="int?"
                                                Label="Familias Impactadas" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.FamilyRestroom" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_modelo.ComunidadesAlcanzadas" 
                                                T="int?"
                                                Label="Comunidades Alcanzadas" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.LocationCity" />
                            </MudItem>

                            @if (_modelo.ObjetivosTotales.HasValue && _modelo.ObjetivosTotales.Value > 0)
                            {
                                <MudItem xs="12">
                                    <div class="metric-card">
                                        <MudText Typo="Typo.body2" Style="color: #6D534F;">
                                            <strong>Cumplimiento de Objetivos:</strong> 
                                            @CalcularPorcentaje(_modelo.ObjetivosCumplidos ?? 0, _modelo.ObjetivosTotales.Value)%
                                        </MudText>
                                        <MudProgressLinear Color="Color.Primary" 
                                                          Value="@CalcularPorcentaje(_modelo.ObjetivosCumplidos ?? 0, _modelo.ObjetivosTotales.Value)" 
                                                          Class="mt-2" />
                                    </div>
                                </MudItem>
                            }
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Alianzas y Colaboraciones -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Handshake" Class="mr-2" />
                            Alianzas y Colaboraciones
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.AlianzasActivas" 
                                                T="int?"
                                                Label="Alianzas Activas" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Hub" />
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.NuevasAlianzas" 
                                                T="int?"
                                                Label="Nuevas Alianzas" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.AddCircle" />
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.AportesEnEspecie" 
                                                T="decimal?"
                                                Label="Aportes en Especie (valor estimado)" 
                                                Min="0"
                                                Format="N2"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentText="$" />
                            </MudItem>
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Capacitaciones -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.School" Class="mr-2" />
                            Formación y Capacitación
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.CapacitacionesRealizadas" 
                                                T="int?"
                                                Label="Capacitaciones Realizadas" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.Class" />
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.PersonasCapacitadas" 
                                                T="int?"
                                                Label="Personas Capacitadas" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.People" />
                            </MudItem>
                            
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_modelo.CertificadosEmitidos" 
                                                T="int?"
                                                Label="Certificados Emitidos" 
                                                Min="0"
                                                Variant="Variant.Outlined"
                                                Adornment="Adornment.Start"
                                                AdornmentIcon="@Icons.Material.Filled.CardMembership" />
                            </MudItem>
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Narrativa - Logros y Retos -->
                <MudItem xs="12">
                    <div class="mythra-section">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2" />
                            Análisis Cualitativo
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_modelo.LogrosPrincipales" 
                                             Label="Logros Principales" 
                                             Lines="3"
                                             Placeholder="Describa los principales logros alcanzados en este periodo..."
                                             Variant="Variant.Outlined"
                                             HelperText="Resuma los logros más significativos" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_modelo.RetosEnfrentados" 
                                             Label="Retos Enfrentados" 
                                             Lines="3"
                                             Placeholder="Describa los principales desafíos o dificultades..."
                                             Variant="Variant.Outlined"
                                             HelperText="Identifique los obstáculos encontrados" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_modelo.LeccionesAprendidas" 
                                             Label="Lecciones Aprendidas" 
                                             Lines="3"
                                             Placeholder="¿Qué aprendizajes se obtuvieron?"
                                             Variant="Variant.Outlined"
                                             HelperText="Conocimiento adquirido para mejorar" />
                            </MudItem>
                            
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_modelo.ProximosPasos" 
                                             Label="Próximos Pasos" 
                                             Lines="3"
                                             Placeholder="¿Qué acciones se planean para el siguiente periodo?"
                                             Variant="Variant.Outlined"
                                             HelperText="Plan de acción futuro" />
                            </MudItem>
                        </MudGrid>
                    </div>
                </MudItem>

                <!-- Botones de acción -->
                <MudItem xs="12" Class="d-flex gap-3 justify-end mt-4">
                    <MudButton Variant="Variant.Outlined"
                              Class="mythra-button-secondary"
                              OnClick="Cancelar"
                              StartIcon="@Icons.Material.Filled.Cancel"
                              Disabled="_guardando">
                        Cancelar
                    </MudButton>
                    
                    <MudButton Variant="Variant.Filled"
                              Class="mythra-button-primary"
                              OnClick="Guardar"
                              StartIcon="@Icons.Material.Filled.Save"
                              Disabled="_guardando">
                        @if (_guardando)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span>Guardar Cambios</span>
                        }
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public int InstanciaId { get; set; }

    private POAViewModel? _poa;
    private EditarPOAModel _modelo = new();
    private bool _guardando = false;
    private bool _cargando = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Cargar POA existente
            _poa = await POAService.ObtenerPOAPorIdAsync(InstanciaId);

            if (_poa == null)
            {
                Snackbar.Add("POA no encontrado", Severity.Error);
                Navigation.NavigateTo("/poas");
                return;
            }

            // Cargar valores actuales del POA
            await CargarValoresActualesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar POA: {ex.Message}", Severity.Error);
            Navigation.NavigateTo("/poas");
        }
        finally
        {
            _cargando = false;
        }
    }

    private async Task CargarValoresActualesAsync()
    {
        var valores = await DbContext.POAValores
            .Include(v => v.Campo)
            .Where(v => v.InstanciaId == InstanciaId && !v.IsDeleted)
            .ToListAsync();

        var instancia = await DbContext.POAInstancias
            .FirstOrDefaultAsync(p => p.InstanciaId == InstanciaId);

        _modelo = new EditarPOAModel
        {
            InstanciaId = InstanciaId,
            ProgramaId = _poa!.ProgramaId,
            Notas = instancia?.Notas
        };

        // Mapear valores de campos dinámicos a modelo estático (case-insensitive)
        foreach (var valor in valores)
        {
            var clave = valor.Campo.Clave.ToUpper();
            
            // Actividades
            if (clave.Contains("ACTIVIDADES_PLANIFICADAS") || clave.Contains("TALLERES_PLAN") || clave.Contains("SESIONES_PLAN"))
            {
                _modelo.ActividadesPlanificadas = (int)(valor.ValorDecimal ?? valor.ValorNumero ?? 0);
            }
            else if (clave.Contains("ACTIVIDADES_EJECUTADAS") || clave.Contains("TALLERES_EJEC") || clave.Contains("SESIONES_EJEC"))
            {
                _modelo.ActividadesEjecutadas = (int)(valor.ValorDecimal ?? valor.ValorNumero ?? 0);
            }
            // Presupuesto
            else if (clave.Contains("PRESUPUESTO_EJECUTADO"))
            {
                _modelo.PresupuestoEjecutado = valor.ValorDecimal;
            }
            else if (clave.Contains("PRESUPUESTO_TOTAL") || clave.Contains("PRESUPUESTO") || clave.Contains("BUDGET"))
            {
                _modelo.PresupuestoTotal = valor.ValorDecimal;
            }
            // Participantes
            else if (clave.Contains("NUEVOS_PARTICIPANTES"))
            {
                _modelo.NuevosParticipantes = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("PARTICIPANTES_RETIRADOS"))
            {
                _modelo.ParticipantesRetirados = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("PARTICIPANTES_ACTIVOS"))
            {
                _modelo.ParticipantesActivos = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("TOTAL_PARTICIPANTES") || clave.Contains("PARTICIPANTES") || clave.Contains("BENEFICIARIOS"))
            {
                _modelo.TotalParticipantes = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            // Recursos Humanos
            else if (clave.Contains("FACILITADORES"))
            {
                _modelo.TotalFacilitadores = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("VOLUNTARIOS") && !clave.Contains("HORAS"))
            {
                _modelo.TotalVoluntarios = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("HORAS_VOLUNTARIADO"))
            {
                _modelo.HorasVoluntariado = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            // Impacto
            else if (clave.Contains("OBJETIVOS_CUMPLIDOS"))
            {
                _modelo.ObjetivosCumplidos = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("OBJETIVOS_TOTALES") || clave.Contains("OBJETIVOS_PLANTEADOS"))
            {
                _modelo.ObjetivosTotales = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("FAMILIAS_IMPACTADAS"))
            {
                _modelo.FamiliasImpactadas = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("COMUNIDADES_ALCANZADAS"))
            {
                _modelo.ComunidadesAlcanzadas = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            // Alianzas
            else if (clave.Contains("NUEVAS_ALIANZAS"))
            {
                _modelo.NuevasAlianzas = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("ALIANZAS_ACTIVAS") || clave.Contains("ALIANZAS"))
            {
                _modelo.AlianzasActivas = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("APORTES_ESPECIE"))
            {
                _modelo.AportesEnEspecie = valor.ValorDecimal;
            }
            // Capacitaciones
            else if (clave.Contains("CAPACITACIONES_REALIZADAS"))
            {
                _modelo.CapacitacionesRealizadas = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("PERSONAS_CAPACITADAS"))
            {
                _modelo.PersonasCapacitadas = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            else if (clave.Contains("CERTIFICADOS_EMITIDOS"))
            {
                _modelo.CertificadosEmitidos = (int?)(valor.ValorDecimal ?? valor.ValorNumero);
            }
            // Narrativa
            else if (clave.Contains("LOGROS_PRINCIPALES"))
            {
                _modelo.LogrosPrincipales = valor.ValorTexto;
            }
            else if (clave.Contains("RETOS_ENFRENTADOS"))
            {
                _modelo.RetosEnfrentados = valor.ValorTexto;
            }
            else if (clave.Contains("LECCIONES_APRENDIDAS"))
            {
                _modelo.LeccionesAprendidas = valor.ValorTexto;
            }
            else if (clave.Contains("PROXIMOS_PASOS"))
            {
                _modelo.ProximosPasos = valor.ValorTexto;
            }
        }
    }

    private async Task Guardar()
    {
        if (_guardando) return;

        _guardando = true;
        try
        {
            await POAService.ActualizarPOAAsync(_modelo);
            Snackbar.Add("POA actualizado exitosamente", Severity.Success);
            Navigation.NavigateTo($"/poa/{InstanciaId}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al actualizar POA: {ex.Message}", Severity.Error);
            _guardando = false;
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo($"/poa/{InstanciaId}");
    }

    private double CalcularPorcentaje(int valor, int total)
    {
        if (total == 0) return 0;
        return Math.Round((valor * 100.0) / total, 2);
    }

    private double CalcularPorcentajeDecimal(decimal valor, decimal total)
    {
        if (total == 0) return 0;
        return (double)Math.Round((valor * 100) / total, 2);
    }

    private string FormatearMoneda(decimal valor)
    {
        return valor.ToString("N2");
    }
}

</AutorizacionWrapper>
