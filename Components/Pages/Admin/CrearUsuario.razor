@page "/Admin/Usuarios/Crear"
@attribute [Authorize(Roles = "Administrador")]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Security
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Programas
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Data
@using System.Security.Cryptography
@using System.Text.RegularExpressions
@using MudBlazor
@using Microsoft.JSInterop

@inject UserManager<Usuario> UserManager
@inject RoleManager<Rol> RoleManager
@inject ApplicationDbContext Context
@inject NavigationManager NavigationManager
@inject ILogger<CrearUsuario> Logger
@inject IJSRuntime JSRuntime
@inject Infrastructure.Services.Security.EmailSenderService EmailSender

<PageTitle>Crear Usuario</PageTitle>

<style>
    .mythra-header {
        background: linear-gradient(90deg, #4D3935 0%, #6D534F 100%);
        color: #FEFEFD;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .mythra-card {
        background: linear-gradient(135deg, #FEFEFD 0%, #F7F7F7 100%);
        border-left: 4px solid #4D3935;
    }

    .mythra-button-primary {
        background: linear-gradient(135deg, #9FD996 0%, #85C97C 100%) !important;
        color: #4D3935 !important;
        font-weight: 600 !important;
    }

    .mythra-button-secondary {
        background-color: transparent !important;
        border: 2px solid #4D3935 !important;
        color: #4D3935 !important;
        font-weight: 600 !important;
    }

    .mythra-section-title {
        color: #4D3935;
        border-bottom: 2px solid #9FD996;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .mythra-alert-success {
        background: linear-gradient(135deg, #9FD996 0%, #85C97C 100%);
        border: 1px solid #85C97C;
        color: #4D3935;
        border-radius: 8px;
    }

    .mythra-alert-warning {
        background: linear-gradient(135deg, #FFE5B4 0%, #FFD89B 100%);
        border: 1px solid #FFD89B;
        color: #4D3935;
        border-radius: 8px;
    }

    .mythra-alert-info {
        background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
        border: 1px solid #90CAF9;
        color: #4D3935;
        border-radius: 8px;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="mythra-header">
        <MudText Typo="Typo.h4">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Class="mr-2" />
            Crear Nuevo Usuario
        </MudText>
    </div>

    <MudPaper Class="mythra-card pa-6" Elevation="3">
     @if (!string.IsNullOrEmpty(errorMessage))
         {
            <MudAlert Severity="Severity.Error" Class="mb-3" CloseIcon="@Icons.Material.Filled.Close" CloseIconClicked="@(() => errorMessage = null)">
                @errorMessage
            </MudAlert>
       }

    @if (!string.IsNullOrEmpty(successMessage))
   {
            <MudAlert Severity="Severity.Success" Class="mb-3" CloseIcon="@Icons.Material.Filled.Close" CloseIconClicked="@(() => successMessage = null)">
                @successMessage
            </MudAlert>
  }

       @if (!string.IsNullOrEmpty(generatedPassword))
     {
            <MudPaper Class="mythra-alert-success pa-4 mb-3" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                    Usuario Creado Exitosamente
                </MudText>
   <p class="mb-2"><strong>Email:</strong> @model.Email</p>
      <p class="mb-3"><strong>Nombre:</strong> @model.Nombres @model.Apellidos</p>
      
       @if (emailEnviado)
       {
                    <MudAlert Severity="Severity.Success" Class="mb-3" Icon="@Icons.Material.Filled.Email">
                        <MudText Typo="Typo.subtitle1" Class="font-weight-bold">¡Credenciales enviadas por email!</MudText>
                        <MudText Typo="Typo.body2">Se ha enviado un correo electrónico a <strong>@model.Email</strong> con las credenciales de acceso.</MudText>
                    </MudAlert>
       }
       else
       {
                    <MudAlert Severity="Severity.Warning" Class="mb-3" Icon="@Icons.Material.Filled.Warning">
                        <MudText Typo="Typo.subtitle1" Class="font-weight-bold">Credenciales generadas</MudText>
                        <MudText Typo="Typo.body2">Se intentó enviar las credenciales por email, pero ocurrió un problema. Puede copiar la contraseña temporal y enviarla manualmente.</MudText>
                    </MudAlert>
       }

       @if (!emailEnviado)
       {
                    <MudPaper Class="pa-3 mb-3" Elevation="1">
                        <MudTextField @bind-Value="@generatedPassword"
                                      Label="Contraseña Temporal"
                                      Variant="Variant.Outlined"
                                      ReadOnly="true"
                                      InputType="@(showPassword ? InputType.Text : InputType.Password)"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Lock"
                                      Class="font-monospace"
                                      Style="font-size: 1.2rem; letter-spacing: 2px;" />
                        <div class="d-flex gap-2 mt-3">
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Default"
                                       OnClick="TogglePasswordVisibility"
                                       StartIcon="@(showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)">
                                @(showPassword ? "Ocultar" : "Mostrar")
                            </MudButton>
                            <MudButton Variant="Variant.Filled"
                                       Class="mythra-button-primary"
                                       OnClick="CopyPassword"
                                       StartIcon="@Icons.Material.Filled.ContentCopy">
                                Copiar
                            </MudButton>
                        </div>
                    </MudPaper>

           @if (passwordCopied)
           {
                        <MudAlert Severity="Severity.Success" Icon="@Icons.Material.Filled.CheckCircle" Class="mb-3">
                            Contraseña copiada al portapapeles
                        </MudAlert>
           }
       }

                <MudAlert Severity="Severity.Info" Class="mb-0" Icon="@Icons.Material.Filled.Info">
                    <MudText Typo="Typo.subtitle2" Class="font-weight-bold mb-2">Próximos pasos:</MudText>
                    <ol class="mb-0">
                        @if (emailEnviado)
                        {
                            <li>El usuario recibirá un email con sus credenciales de acceso</li>
                            <li>Debe revisar su bandeja de entrada (y spam)</li>
                        }
                        else
                        {
                            <li>Envíe estas credenciales al usuario de forma segura</li>
                        }
                        <li>El usuario debe cambiar la contraseña en su primer inicio de sesión</li>
                        <li>Asegúrese de que el usuario haya recibido y entendido las instrucciones</li>
                    </ol>
                </MudAlert>

                <MudDivider Class="my-4" />

                <div class="d-flex justify-content-between gap-3">
                    <MudButton Variant="Variant.Outlined"
                               Class="mythra-button-secondary"
                               OnClick="CrearOtroUsuario"
                               StartIcon="@Icons.Material.Filled.PersonAdd">
                        Crear Otro Usuario
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Class="mythra-button-primary"
                               OnClick="VolverALista"
                               StartIcon="@Icons.Material.Filled.List">
                        Volver a la Lista
                    </MudButton>
                </div>
            </MudPaper>
        }

   @if (string.IsNullOrEmpty(generatedPassword))
     {
     <EditForm Model="@model" OnValidSubmit="HandleValidSubmit">
  <DataAnnotationsValidator />
   
<!-- Sección: Información de Cuenta -->
                <MudText Typo="Typo.h6" Class="mythra-section-title">
                    <MudIcon Icon="@Icons.Material.Filled.Badge" Size="Size.Small" Class="mr-2" />
                    Información de Cuenta
                </MudText>

      <div class="mb-3">
  <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
 <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="usuario@dominio.com" />
     <ValidationMessage For="@(() => model.Email)" class="text-danger" />
   <small class="form-text text-muted">Debe ser un email corporativo o institucional válido</small>
      </div>

  <!-- Sección: Datos Personales -->
                <MudText Typo="Typo.h6" Class="mythra-section-title mt-4">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-2" />
                    Datos Personales
                </MudText>
  
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="nombres" class="form-label">Nombres <span class="text-danger">*</span></label>
       <InputText id="nombres" @bind-Value="model.Nombres" class="form-control" />
     <ValidationMessage For="@(() => model.Nombres)" class="text-danger" />
     </div>
        <div class="col-md-6 mb-3">
      <label for="apellidos" class="form-label">Apellidos <span class="text-danger">*</span></label>
 <InputText id="apellidos" @bind-Value="model.Apellidos" class="form-control" />
   <ValidationMessage For="@(() => model.Apellidos)" class="text-danger" />
        </div>
      </div>

      <div class="mb-3">
   <label for="telefono" class="form-label">Teléfono (Opcional)</label>
        <InputText id="telefono" @bind-Value="model.Telefono" class="form-control" placeholder="+505 8888-8888" />
     <ValidationMessage For="@(() => model.Telefono)" class="text-danger" />
      </div>

      <!-- Sección: Rol y Permisos -->
                <MudText Typo="Typo.h6" Class="mythra-section-title mt-4">
                    <MudIcon Icon="@Icons.Material.Filled.Shield" Size="Size.Small" Class="mr-2" />
                    Rol y Permisos
                </MudText>

      <div class="mb-3">
        <label for="rol" class="form-label">Rol Principal <span class="text-danger">*</span></label>
        <InputSelect id="rol" @bind-Value="model.Rol" class="form-select">
       <option value="">-- Seleccione un rol --</option>
@foreach (var rol in roles)
 {
            <option value="@rol">@rol</option>
  }
        </InputSelect>
     <ValidationMessage For="@(() => model.Rol)" class="text-danger" />
 <small class="form-text text-muted">El rol determina los permisos del usuario en el sistema</small>
    </div>

      <!-- Sección: Programas Asignados -->
                <MudText Typo="Typo.h6" Class="mythra-section-title mt-4">
                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-2" />
                    Programas Asignados
                </MudText>
      
      <div class="mb-3">
    <label class="form-label">Seleccione los programas a los que tiene acceso</label>
        <div class="row">
          @foreach (var programa in availableProgramas)
          {
            <div class="col-md-6 mb-2">
       <div class="form-check">
          <input class="form-check-input" type="checkbox" 
      id="prog_@programa.Id" 
          checked="@model.ProgramasAsignados.Contains(programa.Id)"
   @onchange="@((e) => TogglePrograma(programa.Id, (bool)e.Value!))" />
      <label class="form-check-label" for="prog_@programa.Id">
     <MudChip T="string" Size="Size.Small" Color="Color.Info">@programa.Nombre</MudChip>
   </label>
   </div>
   </div>
          }
        </div>
    @if (model.ProgramasAsignados.Count == 0)
        {
  <small class="text-warning">
   <i class="bi bi-exclamation-triangle"></i> Sin programas asignados, el usuario no podrá acceder a funcionalidades específicas
  </small>
      }
   else
        {
    <small class="text-success">
     <i class="bi bi-check-circle"></i> @model.ProgramasAsignados.Count programa(s) seleccionado(s)
          </small>
        }
      </div>

                <MudAlert Severity="Severity.Info" Class="mt-4" Icon="@Icons.Material.Filled.Info">
                    Se generará una contraseña temporal segura automáticamente. El usuario deberá cambiarla en su primer inicio de sesión.
                </MudAlert>

                <MudDivider Class="my-4" />

                <div class="d-flex justify-content-between gap-3">
                    <MudButton Variant="Variant.Outlined"
                               Class="mythra-button-secondary"
                               OnClick="Cancelar"
                               Disabled="@isSubmitting"
                               StartIcon="@Icons.Material.Filled.Cancel">
                        Cancelar
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Class="mythra-button-primary"
                               ButtonType="ButtonType.Submit"
                               Disabled="@isSubmitting"
                               StartIcon="@Icons.Material.Filled.Save">
                        @if (isSubmitting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Creando...</span>
                        }
                        else
                        {
                            <span>Crear Usuario</span>
                        }
                    </MudButton>
                </div>
            </EditForm>
        }
    </MudPaper>
</MudContainer>

@code {
 private CreateUserModel model = new();
  private List<string> roles = new();
  private List<ProgramaInfo> availableProgramas = new();
  private string? errorMessage;
    private string? successMessage;
    private bool isSubmitting = false;
    private string? generatedPassword;
    private bool showPassword = false;
    private bool passwordCopied = false;
    private bool emailEnviado = false;

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        roles = await RoleManager.Roles
   .Where(r => !r.IsDeleted)
  .Select(r => r.Name ?? "")
   .ToListAsync();

        // Cargar programas disponibles
     availableProgramas = await Context.Programas
      .Where(p => !p.IsDeleted)
 .Select(p => new ProgramaInfo { Id = p.ProgramaId, Nombre = p.Nombre })
        .ToListAsync();
    }

private void TogglePrograma(int programaId, bool isChecked)
 {
  if (isChecked)
     {
         model.ProgramasAsignados.Add(programaId);
        }
        else
        {
  model.ProgramasAsignados.Remove(programaId);
    }
    }

    private void TogglePasswordVisibility()
    {
  showPassword = !showPassword;
      StateHasChanged();
    }

    private async Task CopyPassword()
    {
        try
   {
          // Copiar al portapapeles usando JavaScript
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", generatedPassword);
      passwordCopied = true;
            
          // Ocultar el mensaje después de 3 segundos
            await Task.Delay(3000);
            passwordCopied = false;
   StateHasChanged();
        }
 catch (Exception ex)
        {
            Logger.LogError(ex, "Error al copiar contraseña al portapapeles");
   // Fallback: intentar con un método alternativo
    try
            {
       await JSRuntime.InvokeVoidAsync("eval", $"document.getElementById('passwordField').select(); document.execCommand('copy');");
             passwordCopied = true;
   await Task.Delay(3000);
      passwordCopied = false;
StateHasChanged();
   }
        catch
            {
       // Si falla, el usuario puede copiar manualmente
            }
   }
    }

    private void CrearOtroUsuario()
    {
        model = new();
        generatedPassword = null;
        successMessage = null;
        errorMessage = null;
        passwordCopied = false;
        showPassword = false;
        emailEnviado = false;
    }

    private void VolverALista()
    {
  NavigationManager.NavigateTo("/Admin/Usuarios");
    }

    private async Task HandleValidSubmit()
    {
   if (isSubmitting) return;

      errorMessage = null;
   successMessage = null;
passwordCopied = false;

        // Validar email personalizado
        var emailValidation = ValidateEmail(model.Email);
 if (!string.IsNullOrEmpty(emailValidation))
   {
  errorMessage = emailValidation;
   return;
        }

   // Validar nombres (solo letras y espacios)
        var nombresValidation = ValidateNombreOApellido(model.Nombres, "nombres");
      if (!string.IsNullOrEmpty(nombresValidation))
   {
    errorMessage = nombresValidation;
            return;
        }

        // Validar apellidos (solo letras y espacios)
        var apellidosValidation = ValidateNombreOApellido(model.Apellidos, "apellidos");
    if (!string.IsNullOrEmpty(apellidosValidation))
   {
     errorMessage = apellidosValidation;
       return;
  }

    isSubmitting = true;

        try
        {
      // Obtener usuario current
            var authState = await authenticationState!;
     var currentUserEmail = authState.User.Identity?.Name;

   // Verificar si el email ya existe
    var existingUser = await UserManager.FindByEmailAsync(model.Email);
   if (existingUser != null)
      {
     errorMessage = "Ya existe un usuario con ese email";
   return;
            }

        // Crear persona
      var persona = new Persona
 {
Nombres = model.Nombres.Trim(),
          Apellidos = model.Apellidos.Trim(),
    FechaNacimiento = null,
  Telefono = model.Telefono,
    CreadoEn = DateTime.UtcNow
 };
        Context.Personas.Add(persona);
      await Context.SaveChangesAsync();

     // Generar contraseña temporal fuerte
   var tempPassword = GenerateSecurePassword();

 // Crear usuario
 var usuario = new Usuario
  {
   PersonaId = persona.PersonaId,
             UserName = model.Email,
       Email = model.Email,
          EmailConfirmed = true,
  Estado = Domain.Common.EstadoGeneral.Activo,
    MustChangePassword = true,
    TwoFactorEnabled = true, // Habilitar 2FA por defecto
    CreatedBy = currentUserEmail ?? "Admin",
        CreatedAtUtc = DateTime.UtcNow,
       CreadoEn = DateTime.UtcNow
         };

   var result = await UserManager.CreateAsync(usuario, tempPassword);
     if (!result.Succeeded)
      {
    errorMessage = $"Error al crear usuario: {string.Join("; ", result.Errors.Select(e => e.Description))}";
  
       // Eliminar la persona si falló la creación del usuario
   Context.Personas.Remove(persona);
    await Context.SaveChangesAsync();
      return;
        }

// Asignar rol
   await UserManager.AddToRoleAsync(usuario, model.Rol);

          // Asignar programas seleccionados
     foreach (var programaId in model.ProgramasAsignados)
      {
   var usuarioPrograma = new UsuarioPrograma
       {
UsuarioId = usuario.Id,
       ProgramaId = programaId,
     Desde = DateTime.Today,
CreadoEn = DateTime.UtcNow
    };
     Context.UsuarioProgramas.Add(usuarioPrograma);
          }

       await Context.SaveChangesAsync();

        Logger.LogInformation("Usuario {Email} creado por {CreatedBy} con contraseña temporal", model.Email, currentUserEmail);

        // Guardar la contraseña generada para mostrarla
        generatedPassword = tempPassword;
        successMessage = $"Usuario creado exitosamente";

        // Enviar email con credenciales
        try
        {
            await EmailSender.SendNewUserCredentialsAsync(
                usuario, 
                model.Email, 
                tempPassword, 
                model.Rol
            );
            
            emailEnviado = true;
            Logger.LogInformation("Email de credenciales enviado a {Email}", model.Email);
        }
        catch (Exception emailEx)
        {
            Logger.LogError(emailEx, "Error al enviar email de credenciales a {Email}", model.Email);
            emailEnviado = false;
            // No bloqueamos el flujo si falla el email
        }
   
   // NO redirigir: await Task.Delay(3000); NavigationManager.NavigateTo("/Admin/Usuarios");
   }
      catch (Exception ex)
        {
    Logger.LogError(ex, "Error al crear usuario");
     errorMessage = "Error inesperado al crear usuario. Por favor, intente nuevamente.";
     }
        finally
    {
  isSubmitting = false;
    }
 }

    private string? ValidateEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
       return "El email es requerido";

        // Validar formato básico de email
     var emailRegex = new Regex(@"^[^@\s]+@[^@\s]+\.[^@\s]+$");
        if (!emailRegex.IsMatch(email))
  return "Formato de email inválido";

        // Validar que no sea un email de prueba o genérico
    var invalidPatterns = new[]
 {
      @"^[a-z]@[a-z]\.(com|net|org)$",
            @"^test@",
   @"^prueba@",
     @"^demo@",
@"@test\.",
     @"@ejemplo\.",
    @"@example\."
      };

foreach (var pattern in invalidPatterns)
        {
  if (Regex.IsMatch(email.ToLower(), pattern))
   return "Email no válido. Use un email corporativo o institucional real";
      }

        // Validar dominios de un solo carácter
        var parts = email.Split('@');
      if (parts.Length == 2)
        {
     var domainParts = parts[1].Split('.');
            if (domainParts.Any(p => p.Length < 2))
     return "Dominio de email inválido";
   }

  // Validar longitud mínima del usuario
        if (parts[0].Length < 3)
   return "El nombre de usuario debe tener al menos 3 caracteres";

   return null;
    }

    private string? ValidateNombreOApellido(string valor, string campo)
    {
  if (string.IsNullOrWhiteSpace(valor))
        return $"El campo {campo} es requerido";

        // Validar que solo contenga letras, espacios, tildes y caracteres especiales del español
    var regex = new Regex(@"^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$");
        if (!regex.IsMatch(valor))
 return $"El campo {campo} solo debe contener letras y espacios";

        return null;
 }

    private string GenerateSecurePassword()
    {
        const string validChars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*";
    var password = new char[12];
        
   // Asegurar al menos un carácter de cada tipo
  password[0] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[RandomNumberGenerator.GetInt32(26)];
        password[1] = "abcdefghijklmnopqrstuvwxyz"[RandomNumberGenerator.GetInt32(26)];
  password[2] = "1234567890"[RandomNumberGenerator.GetInt32(10)];
        password[3] = "!@#$%^&*"[RandomNumberGenerator.GetInt32(8)];

        for (int i = 4; i < 12; i++)
      {
   password[i] = validChars[RandomNumberGenerator.GetInt32(validChars.Length)];
   }

  return new string(password.OrderBy(x => RandomNumberGenerator.GetInt32(1000)).ToArray());
    }

    private void Cancelar()
    {
        NavigationManager.NavigateTo("/Admin/Usuarios");
    }

    public class CreateUserModel
    {
 [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "Email inválido")]
     public string Email { get; set; } = "";

  [Required(ErrorMessage = "Los nombres son requeridos")]
  [StringLength(100, ErrorMessage = "Máximo 100 caracteres")]
        public string Nombres { get; set; } = "";

     [Required(ErrorMessage = "Los apellidos son requeridos")]
        [StringLength(100, ErrorMessage = "Máximo 100 caracteres")]
  public string Apellidos { get; set; } = "";

[StringLength(30, ErrorMessage = "Máximo 30 caracteres")]
    public string? Telefono { get; set; }

    [Required(ErrorMessage = "El rol es requerido")]
      public string Rol { get; set; } = "";

 public HashSet<int> ProgramasAsignados { get; set; } = new();
    }

    public class ProgramaInfo
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = "";
    }
}
