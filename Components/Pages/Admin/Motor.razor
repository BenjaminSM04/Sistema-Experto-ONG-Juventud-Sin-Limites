@page "/admin/motor"
@rendermode InteractiveServer
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Api.Models
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Common
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Infrastructure.Services.Inference
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Data
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Security
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "Administrador,Coordinador")]
@inject NavigationManager Navigation
@inject IMotorInferencia MotorInferencia
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<Motor> Logger

<PageTitle>Motor de Inferencia</PageTitle>

<style>
    .mythra-header {
      background: linear-gradient(90deg, #4D3935 0%, #6D534F 100%);
    color: #FEFEFD;
        padding: 1.5rem;
        border-radius: 8px;
     margin-bottom: 2rem;
    }

    .mythra-card {
        background: linear-gradient(135deg, #FEFEFD 0%, #F7F7F7 100%);
        border-left: 4px solid #4D3935;
  }

    .mythra-panel {
        background-color: #F7C484;
        border-radius: 8px;
        padding: 1.5rem;
    }

    .mythra-button-primary {
        background: linear-gradient(135deg, #9FD996 0%, #85C97C 100%) !important;
        color: #4D3935 !important;
        font-weight: 600 !important;
    }

    .mythra-button-primary:hover {
        background: linear-gradient(135deg, #85C97C 0%, #9FD996 100%) !important;
     transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(159, 217, 150, 0.4) !important;
    }

    .mythra-button-success {
        background: linear-gradient(135deg, #9FD996 0%, #85C97C 100%) !important;
     color: #4D3935 !important;
        font-weight: 600 !important;
      border: none !important;
  }

    .mythra-button-success:hover {
   background: linear-gradient(135deg, #85C97C 0%, #9FD996 100%) !important;
    }

    .mythra-button-warning {
        background: linear-gradient(135deg, #F3C95A 0%, #E5BA45 100%) !important;
        color: #4D3935 !important;
   font-weight: 600 !important;
        border: none !important;
    }

    .mythra-button-warning:hover {
        background: linear-gradient(135deg, #E5BA45 0%, #F3C95A 100%) !important;
    }

    .mythra-table-header {
        background-color: #4D3935 !important;
        color: #FEFEFD !important;
     font-weight: 600;
    }

  .mythra-table-row:hover {
        background-color: #F7C48420 !important;
    }

    .mythra-alert-success {
        background: linear-gradient(135deg, #9FD996 0%, #B5E3AD 100%);
        color: #4D3935;
        border-left: 4px solid #4D3935;
}

    .mythra-alert-error {
        background: linear-gradient(135deg, #F3C95A 0%, #F7C484 100%);
        color: #4D3935;
        border-left: 4px solid #4D3935;
    }

    .mythra-chip-info {
        background-color: #9FD996 !important;
        color: #4D3935 !important;
        font-weight: 600;
    }

    .mythra-chip-warning {
     background-color: #F3C95A !important;
        color: #4D3935 !important;
        font-weight: 600;
    }

    .mythra-chip-error {
        background-color: #F7C484 !important;
        color: #4D3935 !important;
        font-weight: 600;
  }

    .mythra-chip-success {
      background-color: #9FD996 !important;
        color: #4D3935 !important;
        font-weight: 600;
    }

    .mythra-chip-secondary {
        background-color: #4D3935 !important;
        color: #FEFEFD !important;
        font-weight: 600;
    }

    .mythra-chip-open {
 background-color: #F3C95A !important;
        color: #4D3935 !important;
        font-weight: 600;
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- Título -->
    <div class="mythra-header">
        <MudText Typo="Typo.h4">
  <MudIcon Icon="@Icons.Material.Filled.Psychology" Class="mr-2" />
      Motor de Inferencia
        </MudText>
  <MudText Typo="Typo.body1" Class="mt-2" Style="opacity: 0.9;">
         Ejecuta el motor de inferencia para detectar alertas y riesgos en los programas
     @if (_esCoordinador)
        {
     <span> (Limitado a tus programas asignados)</span>
  }
     </MudText>
    </div>

    <!-- Panel de Ejecución -->
    <MudPaper Class="mythra-card mb-4" Elevation="3">
        <div class="mythra-panel">
     <MudGrid>
      <MudItem xs="12" md="5">
            <MudDatePicker 
       Label="Fecha de Corte" 
  @bind-Date="_fechaCorte"
      DateFormat="dd/MM/yyyy"
     Editable="true"
      HelperText="Fecha hasta la cual se evaluarán las reglas"
          Style="background-color: #FEFEFD; border-radius: 4px;"
     Placeholder="Seleccione una fecha"
     AdornmentIcon="@Icons.Material.Filled.CalendarToday"
          Adornment="Adornment.End" />
           </MudItem>
     <MudItem xs="12" md="4">
      <MudSelect T="int?" 
  Label="Programa" 
        @bind-Value="_programaId"
                     Clearable="true"
         HelperText="@(_esCoordinador ? "Selecciona uno de tus programas asignados" : "Dejar vacío para evaluar todos los programas")"
            Style="background-color: #FEFEFD; border-radius: 4px;"
        AdornmentIcon="@Icons.Material.Filled.Folder"
        Adornment="Adornment.Start">
           @foreach (var programa in _programasDisponibles)
 {
        <MudSelectItem Value="@((int?)programa.Id)">@programa.Nombre</MudSelectItem>
        }
              </MudSelect>
           </MudItem>
  <MudItem xs="12" md="3" Class="d-flex align-end">
      <MudButton 
    Variant="Variant.Filled" 
    Class="mythra-button-primary"
       StartIcon="@Icons.Material.Filled.PlayArrow" 
  OnClick="HandleEjecutarClick"
        Disabled="@_ejecutando"
 FullWidth="true"
     Size="Size.Large">
           @if (_ejecutando)
            {
        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
      <span>Ejecutando...</span>
             }
   else
          {
   <span>Ejecutar Ahora</span>
     }
     </MudButton>
       </MudItem>
        </MudGrid>
 </div>
    </MudPaper>

    <!-- Resumen de Ejecución -->
    @if (_resumen != null)
    {
        <MudPaper Class="mythra-alert-success mb-4" Elevation="2">
            <div style="padding: 1rem;">
       <MudText Typo="Typo.body1" Class="mb-2" Style="font-weight: 600;">
      <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
            Ejecución Completada
        </MudText>
         <MudGrid>
        <MudItem xs="12" sm="4">
  <MudText Typo="Typo.body2">
     <strong>Reglas Ejecutadas:</strong> @_resumen.ReglasEjecutadas
             </MudText>
 </MudItem>
    <MudItem xs="12" sm="4">
  <MudText Typo="Typo.body2">
          <strong>Alertas Generadas:</strong> @_resumen.AlertasGeneradas
          </MudText>
    </MudItem>
      <MudItem xs="12" sm="4">
             <MudText Typo="Typo.body2">
       <strong>Errores:</strong> @_resumen.Errores
     </MudText>
         </MudItem>
        </MudGrid>
            </div>
    </MudPaper>
    }

    <!-- Mensaje de Error -->
    @if (!string.IsNullOrEmpty(_error))
    {
        <MudPaper Class="mythra-alert-error mb-4" Elevation="2">
            <div class="d-flex align-center justify-space-between" style="padding: 1rem;">
   <div>
    <MudIcon Icon="@Icons.Material.Filled.Error" Class="mr-2" />
     <span>@_error</span>
             </div>
        <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@(() => _error = null)" Style="color: #4D3935;" />
         </div>
  </MudPaper>
    }

    <!-- Mensaje de Éxito -->
  @if (!string.IsNullOrEmpty(_successMessage))
 {
        <MudPaper Class="mythra-alert-success mb-4" Elevation="2">
      <div class="d-flex align-center justify-space-between" style="padding: 1rem;">
 <div>
  <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
      <span>@_successMessage</span>
  </div>
     <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@(() => _successMessage = null)" Style="color: #4D3935;" />
    </div>
    </MudPaper>
 }

    <!-- Tabla de Alertas -->
    <MudPaper Class="mythra-card" Elevation="3">
        <div style="background-color: #F7C484; border-radius: 8px 8px 0 0; padding: 1rem;">
    <MudText Typo="Typo.h6" Style="color: #4D3935; font-weight: 600;">
       <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" />
    Alertas Generadas (@_alertas.Count)
            </MudText>
        </div>
   <MudTable 
      Items="@_alertas" 
            Dense="true" 
  Hover="true" 
            Loading="@_cargando"
 LoadingProgressColor="Color.Primary"
            Breakpoint="Breakpoint.Sm"
            Elevation="0"
        Class="mythra-table">
  <HeaderContent>
          <MudTh Style="background-color: #4D3935; color: #FEFEFD;">ID</MudTh>
      <MudTh Style="background-color: #4D3935; color: #FEFEFD;">Severidad</MudTh>
             <MudTh Style="background-color: #4D3935; color: #FEFEFD;">Mensaje</MudTh>
       <MudTh Style="background-color: #4D3935; color: #FEFEFD;">Programa</MudTh>
     <MudTh Style="background-color: #4D3935; color: #FEFEFD;">Actividad</MudTh>
       <MudTh Style="background-color: #4D3935; color: #FEFEFD;">Participante</MudTh>
                <MudTh Style="background-color: #4D3935; color: #FEFEFD;">Generada</MudTh>
       <MudTh Style="background-color: #4D3935; color: #FEFEFD;">Estado</MudTh>
           <MudTh Style="background-color: #4D3935; color: #FEFEFD;">Acciones</MudTh>
 </HeaderContent>
        <RowTemplate>
     <MudTd DataLabel="ID">
    <MudText Typo="Typo.body2" Style="color: #4D3935; font-weight: 500;">@context.AlertaId</MudText>
        </MudTd>
      <MudTd DataLabel="Severidad">
     <MudChip T="string" Size="Size.Small" Class="@ObtenerClaseSeveridad(context.Severidad)">
        @ObtenerTextoSeveridad(context.Severidad)
            </MudChip>
     </MudTd>
    <MudTd DataLabel="Mensaje">
   <MudText Typo="Typo.body2" Style="color: #4D3935;">@context.Mensaje</MudText>
      </MudTd>
      <MudTd DataLabel="Programa">
         @{
 var nombrePrograma = context.ProgramaId.HasValue ? _programasDisponibles.FirstOrDefault(p => p.Id == context.ProgramaId.Value)?.Nombre ?? context.ProgramaId.Value.ToString() : "-";
          }
        <MudText Typo="Typo.body2" Style="color: #4D3935;">@nombrePrograma</MudText>
         </MudTd>
        <MudTd DataLabel="Actividad">
            <MudText Typo="Typo.body2" Style="color: #4D3935;">@(context.ActividadId?.ToString() ?? "-")</MudText>
                </MudTd>
             <MudTd DataLabel="Participante">
       <MudText Typo="Typo.body2" Style="color: #4D3935;">@(context.ParticipanteId?.ToString() ?? "-")</MudText>
     </MudTd>
       <MudTd DataLabel="Generada">
       <MudText Typo="Typo.caption" Style="color: #4D3935;">
               @context.GeneradaEn.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Estado">
        <MudChip T="string" Size="Size.Small" Class="@ObtenerClaseEstado(context.Estado)">
    @ObtenerTextoEstado(context.Estado)
    </MudChip>
    </MudTd>
           <MudTd DataLabel="Acciones">
    @if (context.Estado == (byte)EstadoAlerta.Abierta)
     {
 <MudButtonGroup Size="Size.Small" Variant="Variant.Filled">
       <MudButton 
Class="mythra-button-success"
     StartIcon="@Icons.Material.Filled.CheckCircle" 
                Size="Size.Small"
        OnClick="@(() => CambiarEstadoAlerta(context.AlertaId, EstadoAlerta.Resuelta, context.RowVersion))">
           Resolver
            </MudButton>
      <MudButton 
         Class="mythra-button-warning"
     StartIcon="@Icons.Material.Filled.Cancel" 
      Size="Size.Small"
           OnClick="@(() => CambiarEstadoAlerta(context.AlertaId, EstadoAlerta.Descartada, context.RowVersion))">
      Descartar
                 </MudButton>
           </MudButtonGroup>
        }
           else
     {
     <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
        }
                </MudTd>
      </RowTemplate>
    <NoRecordsContent>
          <MudText Class="pa-4" Style="color: #4D3935;">
           <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
  No hay alertas para mostrar. Ejecute el motor para generar alertas.
  </MudText>
        </NoRecordsContent>
   <LoadingContent>
      <MudText Class="pa-4" Style="color: #4D3935;">
     <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
      Cargando alertas...
              </MudText>
            </LoadingContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private DateTime? _fechaCorte = DateTime.Now;
 private int? _programaId;
    private bool _ejecutando = false;
    private bool _cargando = false;
    private ResumenEjecucion? _resumen;
 private List<AlertaDto> _alertas = new();
    private string? _error;
    private string? _successMessage;
    private bool _esCoordinador = false;
    private List<ProgramaInfo> _programasDisponibles = new();
    private Usuario? _usuarioActual;

    protected override async Task OnInitializedAsync()
    {
  Logger.LogInformation("🎯 Motor.razor inicializado");
        _alertas = new List<AlertaDto>();

        // Obtener usuario y programas asignados
  var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

     if (user?.Identity?.IsAuthenticated == true)
        {
    _esCoordinador = user.IsInRole("Coordinador");
    
     // Obtener usuario desde la BD con sus programas asignados
            _usuarioActual = await DbContext.Users
     .Include(u => u.UsuarioProgramas)
             .ThenInclude(up => up.Programa)
             .FirstOrDefaultAsync(u => u.Email == user.Identity.Name);

          if (_usuarioActual != null)
       {
    if (_esCoordinador)
         {
    // Coordinadores solo ven sus programas asignados
        _programasDisponibles = _usuarioActual.UsuarioProgramas
       .Where(up => !up.IsDeleted && !up.Programa.IsDeleted)
            .Select(up => new ProgramaInfo { Id = up.ProgramaId, Nombre = up.Programa.Nombre })
    .ToList();

                    Logger.LogInformation("👤 Coordinador {Email} tiene acceso a {Count} programas", 
      _usuarioActual.Email, _programasDisponibles.Count);
             }
     else
                {
         // Administradores ven todos los programas
         _programasDisponibles = await DbContext.Programas
    .Where(p => !p.IsDeleted)
 .Select(p => new ProgramaInfo { Id = p.ProgramaId, Nombre = p.Nombre })
        .ToListAsync();
      }
            }
        }
    }

    private void HandleEjecutarClick()
    {
        Logger.LogInformation("🖱️ HandleEjecutarClick llamado");
        
        // Validar que coordinadores hayan seleccionado un programa
        if (_esCoordinador && !_programaId.HasValue)
        {
   _error = "Por favor, selecciona un programa antes de ejecutar el motor.";
  return;
        }

        _ = EjecutarMotor();
    }

    private async Task EjecutarMotor()
    {
        Logger.LogInformation("🚀 EjecutarMotor() llamado");
        
   _ejecutando = true;
_error = null;
    _successMessage = null;
     _resumen = null;
        _alertas.Clear();
  
        StateHasChanged();

        try
      {
          var fechaCorteOnly = _fechaCorte.HasValue 
              ? DateOnly.FromDateTime(_fechaCorte.Value) 
         : DateOnly.FromDateTime(DateTime.Now);

     Logger.LogInformation("📤 Ejecutando motor: FechaCorte={FechaCorte}, ProgramaId={ProgramaId}", 
                fechaCorteOnly, _programaId);
            
   // Llamada directa al servicio del motor
  var resumen = await MotorInferencia.EjecutarAsync(fechaCorteOnly, _programaId, CancellationToken.None);

       Logger.LogInformation("✅ Motor ejecutado: Reglas={Reglas}, Alertas={Alertas}, Errores={Errores}",
         resumen.ReglasEjecutadas, resumen.AlertasGeneradas, resumen.Errores);

       // Filtrar alertas según los permisos del usuario
     var queryAlertas = DbContext.Alertas.Where(a => !a.IsDeleted);

     if (_esCoordinador && _usuarioActual != null)
    {
           // Coordinadores solo ven alertas de sus programas asignados
      var programasIds = _usuarioActual.UsuarioProgramas
        .Where(up => !up.IsDeleted)
        .Select(up => up.ProgramaId)
   .ToList();

            queryAlertas = queryAlertas.Where(a => a.ProgramaId.HasValue && programasIds.Contains(a.ProgramaId.Value));
         }

    _alertas = await queryAlertas
    .OrderByDescending(a => a.AlertaId)
        .Take(50)
                .Select(a => new AlertaDto(
          a.AlertaId,
              a.Mensaje,
 (byte)a.Severidad,
          (byte)a.Estado,
     a.GeneradaEn,
           a.ReglaId,
   a.ProgramaId,
   a.ActividadId,
         a.ParticipanteId,
         a.RowVersion
         ))
         .ToListAsync();

            Logger.LogInformation("📋 Obtenidas {Count} alertas", _alertas.Count);

            _resumen = new ResumenEjecucion(
       resumen.ReglasEjecutadas,
             resumen.AlertasGeneradas,
         resumen.Errores
            );

  _successMessage = $"Motor ejecutado exitosamente. {_resumen.AlertasGeneradas} alertas generadas.";
        }
 catch (Exception ex)
        {
            _error = $"Error inesperado: {ex.Message}";
            Logger.LogError(ex, "❌ Error ejecutando motor");
        }
        finally
        {
     _ejecutando = false;
            StateHasChanged();
        }
    }

    private async Task CambiarEstadoAlerta(int alertaId, EstadoAlerta nuevoEstado, byte[] rowVersion)
  {
  Logger.LogInformation("🔄 Cambiando estado de alerta {AlertaId} a {Estado}", alertaId, nuevoEstado);

   try
     {
     var alerta = await DbContext.Alertas
     .Where(a => a.AlertaId == alertaId && !a.IsDeleted)
   .FirstOrDefaultAsync();

 if (alerta == null)
  {
      Logger.LogWarning("❌ Alerta {AlertaId} no encontrada", alertaId);
     _error = "Alerta no encontrada.";
     _alertas.RemoveAll(a => a.AlertaId == alertaId);
   StateHasChanged();
         return;
   }

          // Manejo de concurrencia optimista
     if (rowVersion != null && rowVersion.Length > 0)
         {
   DbContext.Entry(alerta).Property(a => a.RowVersion).OriginalValue = rowVersion;
          }

            var comentario = nuevoEstado == EstadoAlerta.Resuelta 
  ? "Alerta resuelta desde el panel del motor" 
     : "Alerta descartada desde el panel del motor";

     // Actualizar alerta
    alerta.Estado = nuevoEstado;
    if (!string.IsNullOrWhiteSpace(comentario))
   {
       alerta.Notas = comentario;
 }
     alerta.ActualizadoEn = DateTime.UtcNow;

     // Si se marca como resuelta, guardar fecha
    if (nuevoEstado == EstadoAlerta.Resuelta)
 {
     alerta.ResueltaEn = DateTime.UtcNow;
            }

  try
    {
    await DbContext.SaveChangesAsync();

       // Actualizar en la lista local
    var alertaDto = _alertas.FirstOrDefault(a => a.AlertaId == alertaId);
    if (alertaDto != null)
     {
         var index = _alertas.IndexOf(alertaDto);
          _alertas[index] = alertaDto with { Estado = (byte)nuevoEstado };
        }

        var mensaje = nuevoEstado == EstadoAlerta.Resuelta ? "Alerta resuelta" : "Alerta descartada";
      Logger.LogInformation("✅ {Mensaje}", mensaje);
  _successMessage = mensaje;
       
      StateHasChanged();
            }
         catch (DbUpdateConcurrencyException)
 {
   var errorMsg = "La alerta fue modificada por otro usuario. Por favor, recargue la página.";
          Logger.LogWarning("⚠️ {Error}", errorMsg);
    _error = errorMsg;
  }
        }
catch (Exception ex)
     {
  Logger.LogError(ex, "❌ Error en CambiarEstadoAlerta");
       _error = $"Error inesperado: {ex.Message}";
      }
    }

    private string ObtenerClaseSeveridad(byte severidad)
    {
        return severidad switch
    {
            1 => "mythra-chip-info",
            2 => "mythra-chip-warning",
     3 => "mythra-chip-error",
 _ => "mythra-chip-info"
        };
    }

    private Color ObtenerColorSeveridad(byte severidad)
    {
   return severidad switch
    {
            1 => Color.Info,
     2 => Color.Warning,
         3 => Color.Error,
 _ => Color.Default
        };
    }

    private string ObtenerTextoSeveridad(byte severidad)
    {
      return severidad switch
  {
       1 => "Info",
 2 => "Alta",
 3 => "Crítica",
      _ => "Desconocida"
  };
    }

    private string ObtenerClaseEstado(byte estado)
    {
    return estado switch
        {
            1 => "mythra-chip-open",
          2 => "mythra-chip-success",
    3 => "mythra-chip-secondary",
    _ => "mythra-chip-info"
        };
    }

    private Color ObtenerColorEstado(byte estado)
    {
        return estado switch
        {
    1 => Color.Warning,
    2 => Color.Success,
    3 => Color.Secondary,
            _ => Color.Default
        };
    }

    private string ObtenerTextoEstado(byte estado)
    {
  return estado switch
   {
1 => "Abierta",
            2 => "Resuelta",
            3 => "Descartada",
   _ => "Desconocido"
      };
    }

    private class ProgramaInfo
    {
 public int Id { get; set; }
        public string Nombre { get; set; } = "";
    }
}
