@page "/programa/{ProgramaId:int}/actividad/crear"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Data
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Operacion
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Programas
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Common
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Infrastructure.Validation
@using Microsoft.EntityFrameworkCore
@attribute [Authorize]

@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject ILogger<CrearActividad> Logger
@inject HtmlSanitizerService HtmlSanitizer

<PageTitle>Crear Actividad</PageTitle>

<style>
    .mythra-header {
        background: linear-gradient(90deg, #4D3935 0%, #6D534F 100%);
        color: #FEFEFD;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

 .mythra-card {
        background: linear-gradient(135deg, #FEFEFD 0%, #F7F7F7 100%);
 border-left: 4px solid #4D3935;
    }

    .mythra-button-primary {
        background: linear-gradient(135deg, #9FD996 0%, #85C97C 100%) !important;
        color: #4D3935 !important;
        font-weight: 600 !important;
    }

    .mythra-button-secondary {
        background-color: transparent !important;
        border: 2px solid #4D3935 !important;
        color: #4D3935 !important;
        font-weight: 600 !important;
    }

    .participantes-section {
        background-color: #F7F7F7;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .participante-item {
        background-color: #FEFEFD;
        border: 1px solid #E0E0E0;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }

    .participante-item:hover {
        border-color: #9FD996;
        box-shadow: 0 2px 4px rgba(159, 217, 150, 0.2);
    }

    .participante-item.selected {
        border-color: #9FD996;
        background-color: rgba(159, 217, 150, 0.1);
    }

    .participantes-counter {
        background-color: #9FD996;
        color: #4D3935;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="mythra-header">
        <MudText Typo="Typo.h4">
       <MudIcon Icon="@Icons.Material.Filled.EventNote" Class="mr-2" />
            Crear Nueva Actividad
        </MudText>
 <MudText Typo="Typo.body1" Class="mt-2" Style="opacity: 0.9;">
            Programa: @(_programa?.Nombre ?? "Cargando...")
     </MudText>
    </div>

    @if (_cargando)
    {
 <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudPaper Class="mythra-card pa-6" Elevation="3">
            <MudForm @ref="_form" @bind-IsValid="@_isValid">
                <MudGrid>
   <MudItem xs="12">
      <MudTextField @bind-Value="_model.Titulo"
    Label="Título de la Actividad"
    Required="true"
       RequiredError="El título es requerido"
   MaxLength="120"
        Variant="Variant.Outlined" />
         </MudItem>

       <MudItem xs="12">
            <MudTextField @bind-Value="_model.Descripcion"
   Label="Descripción"
        Lines="3"
      MaxLength="1000"
          Variant="Variant.Outlined" />
       </MudItem>

   <MudItem xs="12" md="6">
     <MudDatePicker @bind-Date="_model.FechaInicio"
        Label="Fecha de Inicio"
              Required="true"
    Editable="true"
         Variant="Variant.Outlined"
  DateFormat="dd/MM/yyyy" />
    </MudItem>

        <MudItem xs="12" md="6">
              <MudTimePicker @bind-Time="_model.HoraInicio"
                  Label="Hora de Inicio"
        AmPm="true"
      Variant="Variant.Outlined" />
            </MudItem>

    <MudItem xs="12" md="6">
    <MudDatePicker @bind-Date="_model.FechaFin"
     Label="Fecha de Fin"
    Editable="true"
     Variant="Variant.Outlined"
               DateFormat="dd/MM/yyyy" />
      </MudItem>

       <MudItem xs="12" md="6">
             <MudTimePicker @bind-Time="_model.HoraFin"
  Label="Hora de Fin"
   AmPm="true"
             Variant="Variant.Outlined" />
        </MudItem>

       <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Lugar"
                Label="Lugar"
      MaxLength="120"
       Variant="Variant.Outlined" />
         </MudItem>

             <MudItem xs="12" md="6">
    <MudSelect @bind-Value="_model.Tipo"
            Label="Tipo de Actividad"
    Required="true"
    Variant="Variant.Outlined">
    <MudSelectItem Value="@TipoActividad.Taller">Taller</MudSelectItem>
                <MudSelectItem Value="@TipoActividad.Capacitacion">Capacitación</MudSelectItem>
          <MudSelectItem Value="@TipoActividad.Evento">Evento</MudSelectItem>
         <MudSelectItem Value="@TipoActividad.Reunion">Reunión</MudSelectItem>
     <MudSelectItem Value="@TipoActividad.Otro">Otro</MudSelectItem>
         </MudSelect>
          </MudItem>

              <MudItem xs="12" md="6">
     <MudSelect @bind-Value="_model.Estado"
       Label="Estado"
        Required="true"
   Variant="Variant.Outlined">
     <MudSelectItem Value="@EstadoActividad.Planificada">Planificada</MudSelectItem>
         <MudSelectItem Value="@EstadoActividad.Realizada">Realizada</MudSelectItem>
     <MudSelectItem Value="@EstadoActividad.Cancelada">Cancelada</MudSelectItem>
     </MudSelect>
         </MudItem>

                <!-- Sección de Participantes -->
                <MudItem xs="12" Class="mt-4">
                    <MudDivider Class="mb-4" />
                    <div class="d-flex align-center justify-space-between mb-3">
                        <MudText Typo="Typo.h6" Style="color: #4D3935;">
                            <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                            Participantes
                        </MudText>
                        <span class="participantes-counter">@_participantesSeleccionados.Count seleccionados</span>
                    </div>

                    <MudTextField @bind-Value="_busquedaParticipante"
                                  Placeholder="Buscar participante por nombre..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Variant="Variant.Outlined"
                                  Immediate="true"
                                  Class="mb-3" />

                    <div class="d-flex gap-2 mb-3">
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="SeleccionarTodos">
                            Seleccionar Todos
                        </MudButton>
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="DeseleccionarTodos">
                            Deseleccionar Todos
                        </MudButton>
                    </div>

                    <div class="participantes-section" style="max-height: 400px; overflow-y: auto;">
                        @if (!_participantesDisponibles.Any())
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">
                                No hay participantes registrados. Puede crearlos desde la sección de Participantes del programa.
                            </MudAlert>
                        }
                        else
                        {
                            @foreach (var participante in ParticipantesFiltrados)
                            {
                                var isSelected = _participantesSeleccionados.Contains(participante.ParticipanteId);
                                <div class="participante-item @(isSelected ? "selected" : "")">
                                    <MudCheckBox T="bool" 
                                                 Value="@isSelected"
                                                 ValueChanged="@((bool val) => ToggleParticipante(participante.ParticipanteId, val))"
                                                 Color="Color.Success"
                                                 Dense="true">
                                        <div class="d-flex align-center gap-3">
                                            <MudAvatar Size="Size.Small" Style="background: linear-gradient(135deg, #9FD996 0%, #85C97C 100%); color: #4D3935;">
                                                @GetIniciales(participante.Persona.Nombres, participante.Persona.Apellidos)
                                            </MudAvatar>
                                            <div>
                                                <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                                    @participante.Persona.Nombres @participante.Persona.Apellidos
                                                </MudText>
                                                <MudText Typo="Typo.caption" Style="color: #6D534F;">
                                                    @(participante.Persona.Telefono ?? "Sin teléfono")
                                                </MudText>
                                            </div>
                                        </div>
                                    </MudCheckBox>
                                </div>
                            }
                        }
                    </div>
                </MudItem>

<MudItem xs="12" Class="d-flex gap-3 justify-end mt-4">
       <MudButton Variant="Variant.Outlined"
        Class="mythra-button-secondary"
        OnClick="Cancelar"
    StartIcon="@Icons.Material.Filled.ArrowBack">
         Cancelar
          </MudButton>
        <MudButton Variant="Variant.Filled"
     Class="mythra-button-primary"
                   OnClick="Guardar"
    Disabled="@(!_isValid || _guardando)"
     StartIcon="@Icons.Material.Filled.Save">
     @if (_guardando)
      {
  <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
      <span>Guardando...</span>
    }
         else
        {
     <span>Guardar Actividad</span>
           }
   </MudButton>
         </MudItem>
     </MudGrid>
  </MudForm>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public int ProgramaId { get; set; }

    private Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Programas.Programa? _programa;
    private MudForm? _form;
    private bool _isValid;
    private bool _cargando = true;
    private bool _guardando = false;
    private ActividadModel _model = new();
    
    // Participantes
    private List<Participante> _participantesDisponibles = new();
    private HashSet<int> _participantesSeleccionados = new();
    private string _busquedaParticipante = "";

    private IEnumerable<Participante> ParticipantesFiltrados => string.IsNullOrWhiteSpace(_busquedaParticipante)
        ? _participantesDisponibles
        : _participantesDisponibles.Where(p => 
            p.Persona.Nombres.Contains(_busquedaParticipante, StringComparison.OrdinalIgnoreCase) ||
            p.Persona.Apellidos.Contains(_busquedaParticipante, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        try
        {
 _programa = await DbContext.Programas
     .FirstOrDefaultAsync(p => p.ProgramaId == ProgramaId && !p.IsDeleted);

  if (_programa == null)
          {
 Snackbar.Add("Programa no encontrado", Severity.Error);
          NavigationManager.NavigateTo("/programas");
    return;
            }

    _model.Tipo = TipoActividad.Taller;
       _model.Estado = EstadoActividad.Planificada;
       _model.FechaInicio = DateTime.Today;
   _model.HoraInicio = new TimeSpan(18, 0, 0); // 6:00 PM

            // Cargar participantes disponibles
            _participantesDisponibles = await DbContext.Participantes
                .Include(p => p.Persona)
                .Where(p => !p.IsDeleted && !p.Persona.IsDeleted && p.Estado == EstadoGeneral.Activo)
                .OrderBy(p => p.Persona.Apellidos)
                .ThenBy(p => p.Persona.Nombres)
                .ToListAsync();
 }
   catch (Exception ex)
        {
     Logger.LogError(ex, "Error al cargar programa");
      Snackbar.Add("Error al cargar el programa", Severity.Error);
        }
     finally
     {
            _cargando = false;
      }
    }

 private async Task Guardar()
    {
      if (!_isValid || _guardando) return;

        _guardando = true;

        try
        {
            // Sanitizar inputs de texto
            var tituloSanitizado = HtmlSanitizer.SanitizeStrict(_model.Titulo ?? "");
            var descripcionSanitizada = HtmlSanitizer.Sanitize(_model.Descripcion ?? "");
            var lugarSanitizado = HtmlSanitizer.SanitizeStrict(_model.Lugar ?? "");

            var actividad = new Actividad
      {
 ProgramaId = ProgramaId,
           Titulo = tituloSanitizado,
   Descripcion = descripcionSanitizada,
FechaInicio = _model.FechaInicio!.Value.Date.Add(_model.HoraInicio ?? TimeSpan.Zero),
     FechaFin = _model.FechaFin?.Date.Add(_model.HoraFin ?? TimeSpan.Zero),
                Lugar = lugarSanitizado,
             Tipo = _model.Tipo,
          Estado = _model.Estado,
CreadoEn = DateTime.UtcNow
  };

  DbContext.Actividades.Add(actividad);
 await DbContext.SaveChangesAsync();

            // Agregar participantes seleccionados
            foreach (var participanteId in _participantesSeleccionados)
            {
                var actividadParticipante = new ActividadParticipante
                {
                    ActividadId = actividad.ActividadId,
                    ParticipanteId = participanteId,
                    Rol = RolParticipante.Asistente,
                    Estado = EstadoInscripcion.Inscrito,
                    CreadoEn = DateTime.UtcNow
                };
                DbContext.ActividadParticipantes.Add(actividadParticipante);
            }
            
            if (_participantesSeleccionados.Count > 0)
            {
                await DbContext.SaveChangesAsync();
            }

            Snackbar.Add($"Actividad creada exitosamente con {_participantesSeleccionados.Count} participantes", Severity.Success);
            NavigationManager.NavigateTo($"/programa/academia/{ProgramaId}");
   }
        catch (Exception ex)
   {
          Logger.LogError(ex, "Error al crear actividad");
            Snackbar.Add("Error al crear la actividad", Severity.Error);
        }
        finally
        {
            _guardando = false;
  }
    }

    private void Cancelar()
    {
        NavigationManager.NavigateTo($"/programa/academia/{ProgramaId}");
    }

    private void ToggleParticipante(int participanteId, bool seleccionado)
    {
        if (seleccionado)
        {
            _participantesSeleccionados.Add(participanteId);
        }
        else
        {
            _participantesSeleccionados.Remove(participanteId);
        }
    }

    private void SeleccionarTodos()
    {
        foreach (var p in ParticipantesFiltrados)
        {
            _participantesSeleccionados.Add(p.ParticipanteId);
        }
    }

    private void DeseleccionarTodos()
    {
        _participantesSeleccionados.Clear();
    }

    private string GetIniciales(string nombres, string apellidos)
    {
        var inicialesNombres = string.IsNullOrEmpty(nombres) ? "" : nombres.Trim()[0].ToString();
        var inicialesApellidos = string.IsNullOrEmpty(apellidos) ? "" : apellidos.Trim()[0].ToString();
        return $"{inicialesNombres}{inicialesApellidos}".ToUpper();
    }

    private class ActividadModel
    {
        public string? Titulo { get; set; }
        public string? Descripcion { get; set; }
        public DateTime? FechaInicio { get; set; }
        public TimeSpan? HoraInicio { get; set; }
        public DateTime? FechaFin { get; set; }
        public TimeSpan? HoraFin { get; set; }
        public string? Lugar { get; set; }
        public TipoActividad Tipo { get; set; }
        public EstadoActividad Estado { get; set; }
    }
}
