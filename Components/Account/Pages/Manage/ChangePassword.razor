@page "/Account/Manage/ChangePassword"
@layout Sistema_Experto_ONG_Juventud_Sin_Limites.Components.Layout.MainLayout
@using System.ComponentModel.DataAnnotations
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Sistema_Experto_ONG_Juventud_Sin_Limites.Domain.Security
@using MudBlazor
@attribute [Authorize]

@inject UserManager<Usuario> UserManager
@inject SignInManager<Usuario> SignInManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ILogger<ChangePassword> Logger

<PageTitle>Cambiar Contraseña</PageTitle>

<style>
    .mythra-header {
        background: linear-gradient(90deg, #4D3935 0%, #6D534F 100%);
   color: #FEFEFD;
        padding: 1.5rem;
  border-radius: 8px;
        margin-bottom: 2rem;
    }

    .mythra-card {
        background: linear-gradient(135deg, #FEFEFD 0%, #F7F7F7 100%);
border-left: 4px solid #4D3935;
    }

    .mythra-requirements-card {
        background-color: #F7C48420;
        border: 2px solid #F7C484;
        border-radius: 8px;
    }

    .mythra-button-primary {
        background: linear-gradient(135deg, #9FD996 0%, #85C97C 100%) !important;
    color: #4D3935 !important;
      font-weight: 600 !important;
    }

    .mythra-button-primary:hover {
     background: linear-gradient(135deg, #85C97C 0%, #9FD996 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(159, 217, 150, 0.4) !important;
    }

    .mythra-button-secondary {
        background-color: transparent !important;
        border: 2px solid #4D3935 !important;
        color: #4D3935 !important;
    font-weight: 600 !important;
    }

    .mythra-button-secondary:hover {
        background-color: #4D393510 !important;
        transform: translateY(-2px);
    }

    .mythra-alert-success {
        background: linear-gradient(135deg, #9FD996 0%, #B5E3AD 100%);
        color: #4D3935;
    border-left: 4px solid #4D3935;
    }

    .mythra-alert-error {
        background: linear-gradient(135deg, #F3C95A 0%, #F7C484 100%);
        color: #4D3935;
        border-left: 4px solid #4D3935;
    }

    .mythra-alert-warning {
        background: linear-gradient(135deg, #F3C95A 0%, #F7C484 100%);
   color: #4D3935;
        border-left: 4px solid #4D3935;
    }

    .mythra-list-item {
        color: #4D3935;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <div class="mythra-header">
        <MudText Typo="Typo.h4">
     <MudIcon Icon="@Icons.Material.Filled.VpnKey" Class="mr-2" />
    Cambiar Contraseña
        </MudText>
        <MudText Typo="Typo.body1" Class="mt-2" Style="opacity: 0.9;">
            Actualiza tu contraseña de acceso al sistema
        </MudText>
    </div>

    <MudPaper Class="mythra-card" Elevation="3">
        <div style="padding: 2rem;">
 @if (!string.IsNullOrEmpty(message))
       {
   <MudPaper Class="@(isError ? "mythra-alert-error" : "mythra-alert-success")" Elevation="2" Style="margin-bottom: 1.5rem;">
            <div class="d-flex align-center justify-space-between" style="padding: 1rem;">
        <div>
 <MudIcon Icon="@(isError ? Icons.Material.Filled.Error : Icons.Material.Filled.CheckCircle)" Class="mr-2" />
        <span>@message</span>
      </div>
              <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@(() => message = null)" Style="color: #4D3935;" />
      </div>
   </MudPaper>
            }

    <EditForm Model="@inputModel" OnValidSubmit="HandleValidSubmit">
      <DataAnnotationsValidator />

  <MudPaper Class="mythra-requirements-card" Elevation="0" Style="padding: 1rem; margin-bottom: 1.5rem;">
           <MudText Typo="Typo.h6" Class="mb-3" Style="color: #4D3935; font-weight: 600;">
         <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
              Requisitos de Contraseña
     </MudText>
        <MudList T="string" Dense="true">
              <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" 
          IconColor="@(HasMinimumLength(inputModel.NewPassword) ? Color.Success : Color.Default)"
            Class="mythra-list-item">
           Mínimo 8 caracteres
  </MudListItem>
             <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle"
   IconColor="@(HasUpperCase(inputModel.NewPassword) ? Color.Success : Color.Default)"
              Class="mythra-list-item">
     Al menos una letra mayúscula
             </MudListItem>
     <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle"
         IconColor="@(HasLowerCase(inputModel.NewPassword) ? Color.Success : Color.Default)"
          Class="mythra-list-item">
    Al menos una letra minúscula
    </MudListItem>
       <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle"
 IconColor="@(HasDigit(inputModel.NewPassword) ? Color.Success : Color.Default)"
              Class="mythra-list-item">
          Al menos un número
   </MudListItem>
    <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle"
            IconColor="@(HasSpecialChar(inputModel.NewPassword) ? Color.Success : Color.Default)"
 Class="mythra-list-item">
   Al menos un carácter especial (!@@#$%^&*)
       </MudListItem>
         </MudList>
              </MudPaper>

                <MudTextField @bind-Value="inputModel.OldPassword"
             Label="Contraseña Actual"
       Variant="Variant.Outlined"
       InputType="@(showOldPassword ? InputType.Text : InputType.Password)"
                Adornment="Adornment.End"
   AdornmentIcon="@(showOldPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
            OnAdornmentClick="() => showOldPassword = !showOldPassword"
   Required="true"
          RequiredError="La contraseña actual es requerida"
     Class="mb-4"
            Style="background-color: #FEFEFD;" />

         <MudTextField @bind-Value="inputModel.NewPassword"
      Label="Nueva Contraseña"
   Variant="Variant.Outlined"
     InputType="@(showNewPassword ? InputType.Text : InputType.Password)"
         Adornment="Adornment.End"
     AdornmentIcon="@(showNewPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
        OnAdornmentClick="() => showNewPassword = !showNewPassword"
          Required="true"
              RequiredError="La nueva contraseña es requerida"
       Validation="@(new Func<string, string?>(ValidateNewPassword))"
Class="mb-4"
      Style="background-color: #FEFEFD;"
      HelperText="Mínimo 8 caracteres, debe incluir mayúsculas, minúsculas, números y caracteres especiales" />

  <MudTextField @bind-Value="inputModel.ConfirmPassword"
  Label="Confirmar Nueva Contraseña"
     Variant="Variant.Outlined"
    InputType="@(showConfirmPassword ? InputType.Text : InputType.Password)"
           Adornment="Adornment.End"
              AdornmentIcon="@(showConfirmPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
   OnAdornmentClick="() => showConfirmPassword = !showConfirmPassword"
        Required="true"
       RequiredError="Debe confirmar la nueva contraseña"
                    Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
  Class="mb-4"
      Style="background-color: #FEFEFD;" />

             <MudPaper Class="mythra-alert-warning" Elevation="1" Style="margin-bottom: 1.5rem;">
       <div style="padding: 1rem;">
         <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" />
               <MudText Typo="Typo.body2" Inline="true" Style="font-weight: 600;">
          Importante:
                  </MudText>
      <MudText Typo="Typo.body2" Inline="true">
      Después de cambiar tu contraseña, deberás iniciar sesión nuevamente.
        </MudText>
          </div>
                </MudPaper>

      <div class="d-flex gap-3">
        <MudButton ButtonType="ButtonType.Submit"
       Variant="Variant.Filled"
           Class="mythra-button-primary"
        Size="Size.Large"
   FullWidth="true"
      StartIcon="@Icons.Material.Filled.Save"
    Disabled="@isSubmitting">
            @if (isSubmitting)
       {
       <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
      <span>Cambiando...</span>
  }
       else
              {
  <span>Cambiar Contraseña</span>
             }
         </MudButton>

       <MudButton Variant="Variant.Outlined"
           Class="mythra-button-secondary"
             Size="Size.Large"
               StartIcon="@Icons.Material.Filled.ArrowBack"
        Href="/Account/Manage"
           Disabled="@isSubmitting">
     Cancelar
          </MudButton>
 </div>
            </EditForm>
        </div>
    </MudPaper>
</MudContainer>

@code {
    private InputModel inputModel = new();
    private Usuario? user;
    private string? message;
    private bool isError = false;
    private bool isSubmitting = false;
    private bool showOldPassword = false;
    private bool showNewPassword = false;
    private bool showConfirmPassword = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
   var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var currentUser = authState.User;

            if (currentUser?.Identity?.IsAuthenticated == true)
            {
            user = await UserManager.GetUserAsync(currentUser);

   if (user == null)
 {
        NavigationManager.NavigateTo("/Account/Login", true);
         return;
       }

       // Verificar si el usuario tiene contraseña
              var hasPassword = await UserManager.HasPasswordAsync(user);
     if (!hasPassword)
      {
  // Si no tiene contraseña, redirigir a establecer contraseña
       NavigationManager.NavigateTo("/Account/Manage/SetPassword", true);
            return;
        }
    }
            else
      {
             NavigationManager.NavigateTo("/Account/Login", true);
    }
        }
     catch (Exception ex)
   {
            Logger.LogError(ex, "Error al inicializar ChangePassword");
     Snackbar.Add("Error al cargar la página", Severity.Error);
    }
    }

    private async Task HandleValidSubmit()
    {
     if (isSubmitting || user == null) return;

  try
        {
    isSubmitting = true;
         message = null;

  // Validar que las contraseñas coincidan
            if (inputModel.NewPassword != inputModel.ConfirmPassword)
     {
      message = "Las contraseñas no coinciden";
          isError = true;
          return;
       }

      // Validar que la nueva contraseña sea diferente a la actual
            if (inputModel.OldPassword == inputModel.NewPassword)
            {
    message = "La nueva contraseña debe ser diferente a la actual";
   isError = true;
    return;
   }

            // Cambiar la contraseña
   var changePasswordResult = await UserManager.ChangePasswordAsync(user, inputModel.OldPassword, inputModel.NewPassword);

 if (!changePasswordResult.Succeeded)
 {
     var errors = string.Join(", ", changePasswordResult.Errors.Select(e => TranslateError(e.Description)));
    message = $"Error al cambiar la contraseña: {errors}";
         isError = true;
   Logger.LogWarning("Error al cambiar contraseña para usuario {Email}: {Errors}", user.Email, errors);
   return;
       }

         // Si el usuario tenía MustChangePassword, desactivarlo
  if (user.MustChangePassword)
            {
              user.MustChangePassword = false;
      await UserManager.UpdateAsync(user);
  }

    // Refrescar el inicio de sesión
    await SignInManager.RefreshSignInAsync(user);

            Logger.LogInformation("Usuario {Email} cambió su contraseña exitosamente", user.Email);
    
       Snackbar.Add("Contraseña cambiada exitosamente. Redirigiendo...", Severity.Success);

  // Esperar un momento y redirigir
    await Task.Delay(1500);
        NavigationManager.NavigateTo("/Account/Manage", true);
  }
        catch (Exception ex)
  {
            Logger.LogError(ex, "Error inesperado al cambiar contraseña");
    message = "Error inesperado al cambiar la contraseña. Por favor, intente nuevamente.";
            isError = true;
        }
        finally
      {
            isSubmitting = false;
        }
    }

    private string? ValidateNewPassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "La nueva contraseña es requerida";

        if (password.Length < 8)
       return "La contraseña debe tener al menos 8 caracteres";

        if (!HasUpperCase(password))
            return "La contraseña debe contener al menos una letra mayúscula";

        if (!HasLowerCase(password))
    return "La contraseña debe contener al menos una letra minúscula";

        if (!HasDigit(password))
     return "La contraseña debe contener al menos un número";

  if (!HasSpecialChar(password))
       return "La contraseña debe contener al menos un carácter especial (!@#$%^&*)";

        return null;
    }

    private string? ValidateConfirmPassword(string confirmPassword)
    {
     if (string.IsNullOrWhiteSpace(confirmPassword))
      return "Debe confirmar la nueva contraseña";

   if (confirmPassword != inputModel.NewPassword)
            return "Las contraseñas no coinciden";

        return null;
    }

    private bool HasMinimumLength(string? password) => password?.Length >= 8;
    private bool HasUpperCase(string? password) => password?.Any(char.IsUpper) ?? false;
    private bool HasLowerCase(string? password) => password?.Any(char.IsLower) ?? false;
    private bool HasDigit(string? password) => password?.Any(char.IsDigit) ?? false;
    private bool HasSpecialChar(string? password) => password?.Any(c => "!@#$%^&*".Contains(c)) ?? false;

    private string TranslateError(string error)
    {
        return error switch
        {
            var e when e.Contains("password") && e.Contains("incorrect") => "La contraseña actual es incorrecta",
            var e when e.Contains("Password") && e.Contains("short") => "La contraseña es muy corta",
         var e when e.Contains("uppercase") => "La contraseña debe contener al menos una letra mayúscula",
            var e when e.Contains("lowercase") => "La contraseña debe contener al menos una letra minúscula",
  var e when e.Contains("digit") => "La contraseña debe contener al menos un número",
       var e when e.Contains("alphanumeric") => "La contraseña debe contener al menos un carácter especial",
     _ => error
        };
    }

    private class InputModel
    {
      [Required(ErrorMessage = "La contraseña actual es requerida")]
        [DataType(DataType.Password)]
        public string OldPassword { get; set; } = "";

        [Required(ErrorMessage = "La nueva contraseña es requerida")]
        [StringLength(100, ErrorMessage = "La contraseña debe tener al menos {2} caracteres y máximo {1}", MinimumLength = 8)]
  [DataType(DataType.Password)]
     public string NewPassword { get; set; } = "";

        [Required(ErrorMessage = "Debe confirmar la nueva contraseña")]
        [DataType(DataType.Password)]
     [Compare("NewPassword", ErrorMessage = "Las contraseñas no coinciden")]
  public string ConfirmPassword { get; set; } = "";
    }
}
